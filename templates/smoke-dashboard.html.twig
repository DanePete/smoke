{#
/**
 * @file
 * Smoke test dashboard.
 *
 * Variables:
 *   - suites: array of test suite data
 *   - summary: { total, passed, failed, skipped, duration }
 *   - last_run: unix timestamp of last run
 *   - is_setup: boolean
 *   - csrf_token: string
 *   - base_url: string
 */
#}

<div class="smoke-dashboard">

  {# ── Setup banner ── #}
  {% if not is_setup %}
    <div class="smoke-banner smoke-banner--setup">
      <div class="smoke-banner__icon">⚙</div>
      <div class="smoke-banner__content">
        <strong>{{ 'Playwright is not installed yet.'|t }}</strong>
        <p>{{ 'Run this command on your host machine to set up:'|t }}</p>
        <code class="smoke-code">bash web/modules/contrib/smoke/scripts/host-setup.sh</code>
        <p class="smoke-hint">{{ 'After setup, config auto-regenerates on every <code>ddev start</code>.'|t }}</p>
      </div>
    </div>
  {% endif %}

  {# ── Summary bar ── #}
  {% if summary.total > 0 %}
    {% set health = summary.failed == 0 ? 'passed' : (summary.failed <= 2 ? 'warning' : 'failed') %}
    <div class="smoke-summary smoke-summary--{{ health }}">
      <div class="smoke-summary__badge">
        {% if health == 'passed' %}
          <span class="smoke-badge smoke-badge--passed">✓ All Clear</span>
        {% elseif health == 'warning' %}
          <span class="smoke-badge smoke-badge--warning">⚠ {{ summary.failed }} Failed</span>
        {% else %}
          <span class="smoke-badge smoke-badge--failed">✕ {{ summary.failed }} Failed</span>
        {% endif %}
      </div>
      <div class="smoke-summary__stats">
        <span class="smoke-stat">
          <strong>{{ summary.passed }}</strong> {{ 'passed'|t }}
        </span>
        {% if summary.failed > 0 %}
          <span class="smoke-stat smoke-stat--failed">
            <strong>{{ summary.failed }}</strong> {{ 'failed'|t }}
          </span>
        {% endif %}
        {% if summary.skipped > 0 %}
          <span class="smoke-stat smoke-stat--skipped">
            <strong>{{ summary.skipped }}</strong> {{ 'skipped'|t }}
          </span>
        {% endif %}
        <span class="smoke-stat smoke-stat--duration">
          {{ (summary.duration / 1000)|number_format(1) }}s
        </span>
      </div>
      {% if last_run %}
        <div class="smoke-summary__time">
          {{ 'Last run:'|t }} {{ last_run|date('M j, Y g:ia') }}
        </div>
      {% endif %}
    </div>
  {% elseif is_setup %}
    <div class="smoke-banner smoke-banner--ready">
      <div class="smoke-banner__icon">●</div>
      <div class="smoke-banner__content">
        <strong>{{ 'Ready to run.'|t }}</strong>
        <p>{{ 'No test results yet. Click "Run All Tests" or run'|t }} <code class="smoke-code">ddev drush smoke --run</code></p>
      </div>
    </div>
  {% endif %}

  {# ── Actions ── #}
  {% if is_setup %}
    <div class="smoke-actions">
      <form method="post" action="{{ path('smoke.run') }}" class="smoke-actions__form">
        <input type="hidden" name="token" value="{{ csrf_token }}" />
        <button type="submit" class="smoke-btn smoke-btn--primary">
          {{ 'Run All Tests'|t }}
        </button>
      </form>
      {% if base_url %}
        <span class="smoke-actions__env">{{ base_url }}</span>
      {% endif %}
    </div>
  {% endif %}

  {# ── Suite cards ── #}
  <div class="smoke-grid">
    {% for id, suite in suites %}
      <div class="smoke-card smoke-card--{{ suite.status }}">
        <div class="smoke-card__header">
          <div class="smoke-card__title-row">
            <h3 class="smoke-card__title">{{ suite.label }}</h3>
            {% if suite.status == 'passed' %}
              <span class="smoke-badge smoke-badge--passed">✓ {{ 'Passed'|t }}</span>
            {% elseif suite.status == 'failed' %}
              <span class="smoke-badge smoke-badge--failed">✕ {{ 'Failed'|t }}</span>
            {% elseif suite.status == 'skipped' %}
              <span class="smoke-badge smoke-badge--skipped">— {{ 'Skipped'|t }}</span>
            {% else %}
              <span class="smoke-badge smoke-badge--idle">○ {{ 'Not Run'|t }}</span>
            {% endif %}
          </div>
          <p class="smoke-card__desc">{{ suite.description }}</p>
          {% if suite.details.spec_file is defined %}
            <span class="smoke-card__spec">{{ suite.details.spec_file }}</span>
          {% endif %}
        </div>

        {# ── Test results ── #}
        {% if suite.tests|length > 0 %}
          <div class="smoke-card__body">
            <table class="smoke-table">
              <tbody>
                {% for test in suite.tests %}
                  <tr class="smoke-table__row smoke-table__row--{{ test.status }}">
                    <td class="smoke-table__icon">
                      {% if test.status == 'passed' %}
                        <span class="smoke-dot smoke-dot--passed">✓</span>
                      {% elseif test.status == 'failed' %}
                        <span class="smoke-dot smoke-dot--failed">✕</span>
                      {% else %}
                        <span class="smoke-dot smoke-dot--skipped">—</span>
                      {% endif %}
                    </td>
                    <td class="smoke-table__name">{{ test.title }}</td>
                    <td class="smoke-table__time">{{ (test.duration / 1000)|number_format(1) }}s</td>
                  </tr>
                  {% if test.error %}
                    <tr class="smoke-table__error-row">
                      <td></td>
                      <td colspan="2">
                        <pre class="smoke-error">{{ test.error|slice(0, 300) }}</pre>
                      </td>
                    </tr>
                  {% endif %}
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}

        {# ── Technical details panel ── #}
        {% if suite.details is not empty and suite.status != 'skipped' %}
          <details class="smoke-details">
            <summary class="smoke-details__toggle">{{ 'Test Details'|t }}</summary>
            <div class="smoke-details__content">

              {# Tested paths #}
              {% if suite.details.tested_paths is defined and suite.details.tested_paths|length > 0 %}
                <div class="smoke-detail-group">
                  <h4 class="smoke-detail-group__title">{{ 'Tested Paths'|t }}</h4>
                  <ul class="smoke-detail-list">
                    {% for path in suite.details.tested_paths %}
                      <li><code class="smoke-mono">{{ path }}</code></li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}

              {# Custom URLs #}
              {% if suite.details.custom_urls is defined and suite.details.custom_urls|length > 0 %}
                <div class="smoke-detail-group">
                  <h4 class="smoke-detail-group__title">{{ 'Custom URLs'|t }}</h4>
                  <ul class="smoke-detail-list">
                    {% for url in suite.details.custom_urls %}
                      <li><code class="smoke-mono">{{ url }}</code></li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}

              {# Webform fields #}
              {% if suite.details.fields is defined and suite.details.fields|length > 0 %}
                <div class="smoke-detail-group">
                  <h4 class="smoke-detail-group__title">{{ 'Webform Fields'|t }} <code class="smoke-mono">{{ suite.details.webform_id|default('smoke_test') }}</code></h4>
                  <table class="smoke-detail-table">
                    <thead>
                      <tr>
                        <th>{{ 'Key'|t }}</th>
                        <th>{{ 'Type'|t }}</th>
                        <th>{{ 'Label'|t }}</th>
                        <th>{{ 'Required'|t }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for field in suite.details.fields %}
                        <tr>
                          <td><code class="smoke-mono">{{ field.key }}</code></td>
                          <td><code class="smoke-mono">{{ field.type }}</code></td>
                          <td>{{ field.title }}</td>
                          <td>{% if field.required %}<span class="smoke-required">●</span>{% else %}—{% endif %}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}

              {# Commerce flags #}
              {% if suite.details.flags is defined %}
                <div class="smoke-detail-group">
                  <h4 class="smoke-detail-group__title">{{ 'Detected Features'|t }}</h4>
                  <div class="smoke-flags">
                    {% for flag, value in suite.details.flags %}
                      <span class="smoke-flag smoke-flag--{{ value ? 'on' : 'off' }}">
                        {{ value ? '✓' : '✕' }} {{ flag }}
                      </span>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}

              {# Checks #}
              {% if suite.details.checks is defined and suite.details.checks|length > 0 %}
                <div class="smoke-detail-group">
                  <h4 class="smoke-detail-group__title">{{ 'What It Checks'|t }}</h4>
                  <ul class="smoke-detail-list smoke-detail-list--checks">
                    {% for check in suite.details.checks %}
                      <li>{{ check }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}

              {# Selectors #}
              {% if suite.details.selectors is defined %}
                <div class="smoke-detail-group">
                  <h4 class="smoke-detail-group__title">{{ 'Selectors & Locators'|t }}</h4>
                  <table class="smoke-detail-table">
                    <thead>
                      <tr>
                        <th>{{ 'Selector'|t }}</th>
                        <th>{{ 'Purpose'|t }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for selector, purpose in suite.details.selectors %}
                        <tr>
                          <td><code class="smoke-mono">{{ selector }}</code></td>
                          <td>{{ purpose }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}

              {# Auth info #}
              {% if suite.details.test_user is defined %}
                <div class="smoke-detail-group">
                  <h4 class="smoke-detail-group__title">{{ 'Test User'|t }}</h4>
                  <p><code class="smoke-mono">{{ suite.details.test_user }}</code> (role: <code class="smoke-mono">{{ suite.details.test_role }}</code>)</p>
                </div>
              {% endif %}

              {% if suite.details.requires_auth is defined and suite.details.requires_auth %}
                <p class="smoke-detail-note">⚠ {{ 'Admin tests require smoke_bot login. Skipped on remote targets.'|t }}</p>
              {% endif %}

            </div>
          </details>
        {% endif %}

        {# ── Card footer with actions + links ── #}
        <div class="smoke-card__footer">
          <div class="smoke-card__footer-left">
            {% if suite.status != 'skipped' and is_setup %}
              <form method="post" action="{{ path('smoke.run_suite', { suite: id }) }}">
                <input type="hidden" name="token" value="{{ csrf_token }}" />
                <button type="submit" class="smoke-btn smoke-btn--small">
                  {{ 'Run'|t }}
                </button>
              </form>
            {% endif %}
            {% if suite.passed > 0 or suite.failed > 0 %}
              <span class="smoke-card__count">
                {{ suite.passed }}/{{ suite.passed + suite.failed }}
              </span>
            {% endif %}
          </div>
          {% if suite.links|length > 0 and suite.status != 'skipped' %}
            <div class="smoke-card__links">
              {% for link in suite.links %}
                <a href="{{ link.url }}" class="smoke-link" target="_blank">{{ link.label }}</a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  {# ── CLI reference ── #}
  {% if is_setup %}
    <div class="smoke-cli-ref">
      <h3 class="smoke-cli-ref__title">{{ 'CLI Quick Reference'|t }}</h3>
      <div class="smoke-cli-ref__commands">
        <div class="smoke-cli-cmd">
          <code class="smoke-code">ddev drush smoke --run</code>
          <span>{{ 'Run all tests'|t }}</span>
        </div>
        <div class="smoke-cli-cmd">
          <code class="smoke-code">ddev drush smoke:suite core_pages</code>
          <span>{{ 'Run one suite'|t }}</span>
        </div>
        <div class="smoke-cli-cmd">
          <code class="smoke-code">ddev drush smoke --run --target=https://...</code>
          <span>{{ 'Test remote site'|t }}</span>
        </div>
        <div class="smoke-cli-cmd">
          <code class="smoke-code">ddev drush smoke:setup</code>
          <span>{{ 'Regenerate config'|t }}</span>
        </div>
      </div>
    </div>
  {% endif %}

</div>
